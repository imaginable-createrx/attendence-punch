<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- Mobile responsiveness -->
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NEET App: Attendance, Materials & Tests</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600&display=swap" rel="stylesheet" />
  <style>
    /* ================================
       Global Reset & Base Styles 
    ================================ */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #667eea, #764ba2);
      padding: 20px;
      color: #333;
    }
    a { text-decoration: none; color: inherit; }
    .hidden { display: none; }

    /* ================================
       LOGIN & REGISTRATION SCREEN
    ================================ */
    .login-wrapper {
      max-width: 400px;
      margin: 5% auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .login-header {
      display: flex;
      background: #f6f6f6;
    }
    .login-header div {
      flex: 1;
      text-align: center;
      padding: 15px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.3s;
      color: #555;
    }
    .login-header div.active {
      background: #fff;
      border-bottom: 2px solid #667eea;
      color: #667eea;
    }
    /* Three login sections: Child, Parent, Teacher */
    .login-form, .register-form {
      padding: 20px;
    }
    .login-form h2, .register-form h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    .login-form input, .register-form input {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }
    .login-form input:focus, .register-form input:focus {
      outline: none;
      border-color: #667eea;
    }
    .btn {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 6px;
      background: #667eea;
      color: #fff;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      margin-top: 10px;
      transition: background 0.3s;
    }
    .btn:hover { background: #5a67d8; }
    .toggle-link {
      margin-top: 10px;
      text-align: center;
      color: #667eea;
      cursor: pointer;
      text-decoration: underline;
      font-size: 0.9rem;
    }

    /* ================================
       DASHBOARD STYLES
    ================================ */
    .dashboard {
      max-width: 900px;
      margin: 20px auto;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    .dashboard-nav { background: #667eea; }
    .dashboard-nav ul {
      list-style: none;
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 0;
    }
    .dashboard-nav ul li {
      padding: 15px 20px;
      color: #fff;
      cursor: pointer;
      transition: background 0.3s;
    }
    .dashboard-nav ul li.active,
    .dashboard-nav ul li:hover { background: #5a67d8; }
    .dashboard-nav ul li.logout { background: #e53e3e; }
    .dashboard-nav ul li.logout:hover { background: #c53030; }
    /* Teacher nav extended to include "Upload Test" and "Upload Material" tabs */
    .teacher-nav ul li.uploadTest { background: #4caf50; }
    .teacher-nav ul li.uploadTest:hover { background: #43a047; }
    .teacher-nav ul li.uploadMaterial { background: #4caf50; }
    .teacher-nav ul li.uploadMaterial:hover { background: #43a047; }
    .dashboard-content { padding: 20px; }

    /* ================================
       CHILD DASHBOARD SECTIONS
    ================================ */
    .attendance-section { text-align: center; }
    .attendance-section h3 { margin-bottom: 15px; color: #667eea; }
    .attendance-section .message { margin-top: 15px; font-size: 1.1rem; color: #28a745; }
    #attendanceCalendar { margin-top: 20px; }
    #attendanceCalendar table {
      width: 100%;
      border-collapse: collapse;
      text-align: center;
    }
    #attendanceCalendar th, #attendanceCalendar td {
      border: 1px solid #ccc;
      padding: 5px;
    }
    #attendanceNotifications { margin-top: 20px; text-align: center; }
    #attendanceNotifications h3 { margin-bottom: 10px; color: #667eea; }
    #notificationsSection div { border-bottom: 1px solid #ddd; padding: 10px 0; }
    .accordion { margin: 20px auto; max-width: 800px; }
    .grade-block { margin-bottom: 20px; }
    .grade-block h3 { text-align: center; margin-bottom: 10px; color: #667eea; }
    .accordion details {
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 6px;
      margin-bottom: 10px;
      padding: 10px;
    }
    .accordion details summary {
      cursor: pointer;
      padding: 10px;
      font-size: 1.1rem;
      font-weight: 500;
      color: #667eea;
      list-style: none;
    }
    .accordion details summary::-webkit-details-marker { display: none; }
    .accordion details ul { margin-top: 10px; padding-left: 20px; }
    .accordion details ul li { margin-bottom: 8px; }
    .accordion details ul li a {
      display: inline-block;
      padding: 6px 10px;
      background: #667eea;
      color: #fff;
      border-radius: 4px;
      font-size: 0.9rem;
      transition: background 0.3s;
    }
    .accordion details ul li a:hover { background: #5a67d8; }
    #testList { margin-top: 20px; }
    #testList button { margin-bottom: 10px; }
    #childResultsTab { margin-top: 20px; }
    #childResultsTab table {
      width: 100%;
      border-collapse: collapse;
      text-align: center;
    }
    #childResultsTab th, #childResultsTab td {
      border: 1px solid #ccc;
      padding: 8px;
    }
    /* Child Profile Section */
    #childProfileTab { margin-top: 20px; }
    #childProfileTab p { margin: 10px 0; }

    /* ================================
       TEST PAGE
    ================================ */
    #testPage {
      max-width: 900px;
      margin: 20px auto;
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    #pdfTestContainer {
      position: relative;
      margin: 20px auto;
      max-width: 900px;
      border: 1px solid #ccc;
      border-radius: 6px;
      overflow: hidden;
    }
    #pdfViewer { width: 100%; height: 600px; }
    #pdfTimer {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 1.2rem;
      font-weight: 500;
    }
    #finishTestBtn { margin: 10px auto; display: block; }
    #uploadSection { text-align: center; margin-top: 20px; }
    #uploadSection input[type="file"] { margin-bottom: 10px; }
    #returnBtn { margin-top: 20px; }
    
    /* ================================
       TEACHER DASHBOARD
    ================================ */
    .teacher-nav ul {
      list-style: none;
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 0;
      background: #667eea;
    }
    .teacher-nav ul li {
      padding: 15px 20px;
      color: #fff;
      cursor: pointer;
      transition: background 0.3s;
    }
    .teacher-nav ul li.active,
    .teacher-nav ul li:hover { background: #5a67d8; }
    .teacher-nav ul li.logout { background: #e53e3e; }
    .teacher-nav ul li.logout:hover { background: #c53030; }
    .teacher-nav ul li.uploadTest { background: #4caf50; }
    .teacher-nav ul li.uploadTest:hover { background: #43a047; }
    .teacher-nav ul li.uploadMaterial { background: #4caf50; }
    .teacher-nav ul li.uploadMaterial:hover { background: #43a047; }
    
    /* ================================
       PARENT DASHBOARD
    ================================ */
    .parent-nav ul {
      list-style: none;
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 0;
      background: #667eea;
    }
    .parent-nav ul li {
      padding: 15px 20px;
      color: #fff;
      cursor: pointer;
      transition: background 0.3s;
    }
    .parent-nav ul li.active,
    .parent-nav ul li:hover { background: #5a67d8; }
    .parent-nav ul li.logout { background: #e53e3e; }
    .parent-nav ul li.logout:hover { background: #c53030; }
    
    /* ================================
       Mobile Responsiveness
    ================================ */
    @media (max-width: 600px) {
      body { padding: 10px; }
      .login-wrapper, .dashboard { width: 100%; margin: 0 auto; border-radius: 0; }
      .dashboard-nav ul, .parent-nav ul { flex-direction: column; }
      .dashboard-nav ul li, .parent-nav ul li { width: 100%; text-align: center; }
      #attendanceCalendar table, #childResultsTab table { font-size: 0.8rem; }
      iframe#pdfViewer { height: 400px; }
      .accordion { width: 100%; }
    }
  </style>
</head>
<body>
  <!-- ================================
       LOGIN & REGISTRATION SCREEN
    ================================ -->
  <div class="login-wrapper" id="loginContainer">
    <div class="login-header">
      <div id="childLoginTab" class="active" onclick="switchLogin('child')">Child Login</div>
      <div id="parentLoginTab" onclick="switchLogin('parent')">Parent Login</div>
      <div id="teacherLoginTab" onclick="switchLogin('teacher')">Teacher Login</div>
    </div>
    <!-- Child Login Form -->
    <div class="login-form" id="childLoginForm">
      <h2>Child Login</h2>
      <input type="email" id="childEmail" placeholder="Email" required>
      <input type="password" id="childPassword" placeholder="Password" required>
      <button class="btn" onclick="childLogin()">Login</button>
      <p class="toggle-link" onclick="showRegisterForm()">Don't have an account? Register</p>
    </div>
    <!-- Registration Form for Child (includes Display Name and Parent Email) -->
    <div class="register-form hidden" id="childRegisterForm">
      <h2>Register</h2>
      <input type="text" id="regName" placeholder="Enter your name" required>
      <input type="email" id="regEmail" placeholder="Email" required>
      <input type="password" id="regPassword" placeholder="Password" required>
      <input type="password" id="regPasswordConfirm" placeholder="Confirm Password" required>
      <input type="email" id="regParent" placeholder="Parent Email (use same as parent's login)">
      <button class="btn" onclick="childRegister()">Register</button>
      <p class="toggle-link" onclick="showLoginForm()">Already have an account? Login</p>
    </div>
    <!-- Parent Login Form -->
    <div class="login-form hidden" id="parentLoginForm">
      <h2>Parent Login</h2>
      <input type="email" id="parentEmail" placeholder="Parent Email" required>
      <input type="password" id="parentPassword" placeholder="Password" required>
      <button class="btn" onclick="parentLogin()">Login</button>
      <p class="toggle-link" onclick="showParentRegisterForm()">Don't have an account? Register as Parent</p>
    </div>
    <!-- Parent Registration Form -->
    <div class="register-form hidden" id="parentRegisterForm">
      <h2>Parent Registration</h2>
      <input type="email" id="parentRegEmail" placeholder="Parent Email" required>
      <input type="password" id="parentRegPassword" placeholder="Password" required>
      <input type="password" id="parentRegPasswordConfirm" placeholder="Confirm Password" required>
      <button class="btn" onclick="parentRegister()">Register</button>
      <p class="toggle-link" onclick="showParentLoginForm()">Already have an account? Login</p>
    </div>
    <!-- Teacher Login Form -->
    <div class="login-form hidden" id="teacherLoginForm">
      <h2>Teacher Login</h2>
      <input type="text" id="teacherUsername" placeholder="Username" required>
      <input type="password" id="teacherPassword" placeholder="Password" required>
      <button class="btn" onclick="teacherLogin()">Login</button>
    </div>
  </div>
  
  <!-- ================================
       CHILD DASHBOARD
    ================================ -->
  <div class="dashboard hidden" id="childDashboard">
    <nav class="dashboard-nav">
      <ul>
        <li class="active" data-tab="attendance" onclick="switchChildTab('attendance')">Attendance</li>
        <li data-tab="materials" onclick="switchChildTab('materials')">Study Materials</li>
        <li data-tab="tests" onclick="switchChildTab('tests')">Tests</li>
        <li data-tab="results" onclick="switchChildTab('results')">Results</li>
        <li data-tab="profile" onclick="switchChildTab('profile')">Profile</li>
        <li class="logout" onclick="childLogout()">Logout</li>
      </ul>
    </nav>
    <div class="dashboard-content">
      <!-- Attendance Section -->  
      <div id="childAttendanceTab">
        <div class="attendance-section">
          <h3>Mark Your Attendance</h3>
          <button class="btn" id="attendanceBtn" onclick="markAttendance()">Mark Attendance</button>
          <div class="message" id="attendanceMsg"></div>
          <div id="attendanceCalendar"></div>
          <div id="attendanceNotifications">
            <h3>Announcements</h3>
            <div id="notificationsSection"></div>
          </div>
        </div>
      </div>
      <!-- Study Materials Section -->
      <div id="childMaterialsTab" class="hidden">
        <h3 style="text-align:center; color:#667eea; margin-bottom:20px;">Study Materials</h3>
        <div class="accordion" id="materialsAccordion"></div>
      </div>
      <!-- Tests Section -->  
      <div id="childTestsTab" class="hidden">
        <h3 style="text-align:center; color:#667eea; margin-bottom:20px;">Available Tests</h3>
        <div id="testList"></div>
      </div>
      <!-- Results Section -->  
      <div id="childResultsTab" class="hidden">
        <h3 style="text-align:center; color:#667eea; margin-bottom:20px;">Test Results</h3>
        <table>
          <thead>
            <tr>
              <th>Test Name</th>
              <th>Status</th>
              <th>Grade</th>
            </tr>
          </thead>
          <tbody id="resultsTableBody"></tbody>
        </table>
      </div>
      <!-- Profile Section -->
      <div id="childProfileTab" class="hidden">
        <h3 style="text-align:center; color:#667eea; margin-bottom:20px;">My Profile</h3>
        <div id="profileInfo"></div>
        <button class="btn" onclick="editProfile()">Edit Profile</button>
      </div>
    </div>
  </div>
  
  <!-- ================================
       TEST PAGE
    ================================ -->
  <div class="dashboard hidden" id="testPage">
    <h2 style="text-align:center; color:#667eea; margin-bottom:20px;">NEET Mock Test</h2>
    <div id="testInterface"></div>
    <button class="btn hidden" id="returnBtn" onclick="returnToDashboard()">Return to Dashboard</button>
  </div>
  
  <!-- ================================
       TEACHER DASHBOARD
    ================================ -->
  <div class="dashboard hidden" id="teacherDashboard">
    <nav class="teacher-nav">
      <ul>
        <li class="active" data-tab="attendance" onclick="switchTeacherTab('attendance')">Attendance</li>
        <li data-tab="reviewTests" onclick="switchTeacherTab('reviewTests')">Review Tests</li>
        <li data-tab="uploadTest" onclick="switchTeacherTab('uploadTest')">Upload Test</li>
        <li data-tab="uploadMaterial" onclick="switchTeacherTab('uploadMaterial')">Upload Material</li>
        <li class="logout" onclick="teacherLogout()">Logout</li>
      </ul>
    </nav>
    <div class="dashboard-content" id="teacherContent"></div>
  </div>
  
  <!-- ================================
       PARENT DASHBOARD
    ================================ -->
  <div class="dashboard hidden" id="parentDashboard">
    <nav class="parent-nav">
      <ul>
        <li class="active" data-tab="profiles" onclick="switchParentTab('profiles')">Child Profiles</li>
        <li data-tab="progress" onclick="switchParentTab('progress')">Progress</li>
        <li class="logout" onclick="parentLogout()">Logout</li>
      </ul>
    </nav>
    <div class="dashboard-content" id="parentContent"></div>
  </div>
  
  <!-- ================================
       JAVASCRIPT
    ================================ -->
  <script>
    /* ================================
       Global Variables
    ================================ */
    var currentChild = "";
    var currentTestId = "";
    var currentTestPdf = "";
    
    /* Teacher Credentials (fixed) */
    var teacherCredentials = { username: "teacher", password: "teacher123" };
    
    /* Parent Users Utility */
    function getParentUsers() {
      var users = localStorage.getItem("parentUsers");
      return users ? JSON.parse(users) : [];
    }
    function setParentUsers(users) {
      localStorage.setItem("parentUsers", JSON.stringify(users));
    }
    
    /* Child Users Utility */
    function getChildUsers() {
      var users = localStorage.getItem("childUsers");
      return users ? JSON.parse(users) : [];
    }
    function setChildUsers(users) {
      localStorage.setItem("childUsers", JSON.stringify(users));
    }
    
    /* ================================
       Uploaded Tests (Teacher Uploaded)
    ================================ */
    function getUploadedTests() {
      var tests = localStorage.getItem("uploadedTests");
      return tests ? JSON.parse(tests) : [];
    }
    function setUploadedTests(tests) {
      localStorage.setItem("uploadedTests", JSON.stringify(tests));
    }
    
    /* ================================
       Uploaded Study Materials (Teacher Uploaded)
    ================================ */
    function getUploadedMaterials() {
      var materials = localStorage.getItem("uploadedMaterials");
      return materials ? JSON.parse(materials) : [];
    }
    function setUploadedMaterials(materials) {
      localStorage.setItem("uploadedMaterials", JSON.stringify(materials));
    }
    
    /* ================================
       Test Time Limit (Default for static tests)
    ================================ */
    const testTimeLimit = 600; // 10 minutes (if not overridden by teacher-uploaded test)
    var pdfTestTimerInterval, pdfTestTimeRemaining;
    
    /* ================================
       Attendance Utilities
    ================================ */
    function getAttendanceRecords(child) {
      let rec = localStorage.getItem("attendanceRecords_" + child);
      return rec ? JSON.parse(rec) : {};
    }
    function setAttendanceRecords(child, records) {
      localStorage.setItem("attendanceRecords_" + child, JSON.stringify(records));
    }
    
    /* ================================
       Render Attendance Calendar
    ================================ */
    function renderAttendanceCalendar(containerId) {
      const container = document.getElementById(containerId);
      container.innerHTML = "";
      let childKey = currentChild || "default";
      const records = getAttendanceRecords(childKey);
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth();
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      
      let table = document.createElement("table");
      const daysOfWeek = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
      let headerRow = document.createElement("tr");
      daysOfWeek.forEach(day => {
        let th = document.createElement("th");
        th.textContent = day;
        headerRow.appendChild(th);
      });
      table.appendChild(headerRow);
      
      let date = 1;
      for (let i = 0; i < 6; i++) {
        let row = document.createElement("tr");
        for (let j = 0; j < 7; j++) {
          let cell = document.createElement("td");
          if (i === 0 && j < firstDay) {
            cell.textContent = "";
          } else if (date > daysInMonth) {
            cell.textContent = "";
          } else {
            cell.textContent = date;
            let dateStr = `${year}-${(month+1).toString().padStart(2, '0')}-${date.toString().padStart(2, '0')}`;
            let cellDate = new Date(year, month, date);
            cell.style.backgroundColor = cellDate > now ? "#eee" : (records[dateStr] ? "#c6f6d5" : "#fed7d7");
            date++;
          }
          row.appendChild(cell);
        }
        table.appendChild(row);
        if (date > daysInMonth) break;
      }
      container.appendChild(table);
    }
    
    /* ================================
       Persistent Login for Child
    ================================ */
    window.addEventListener("load", function() {
      var storedChild = localStorage.getItem("loggedInChild");
      if (storedChild) {
        currentChild = storedChild;
        document.getElementById('loginContainer').classList.add('hidden');
        document.getElementById('childDashboard').classList.remove('hidden');
        switchChildTab('attendance');
        var now = new Date();
        var todayStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
        var records = getAttendanceRecords(currentChild);
        if (records[todayStr]) {
          document.getElementById('attendanceMsg').textContent = "Attendance marked at " + records[todayStr];
          document.getElementById('attendanceBtn').disabled = true;
        }
        loadStudyMaterials();
        renderAttendanceCalendar("attendanceCalendar");
        loadNotifications();
        loadTestList();
        loadResults();
        loadProfile();
      }
    });
    
    /* ================================
       Login Screen Switching
    ================================ */
    function switchLogin(type) {
      // Hide all login/register forms first.
      document.getElementById('childLoginForm').classList.add('hidden');
      document.getElementById('childRegisterForm').classList.add('hidden');
      document.getElementById('parentLoginForm').classList.add('hidden');
      document.getElementById('parentRegisterForm').classList.add('hidden');
      document.getElementById('teacherLoginForm').classList.add('hidden');
      // Remove active class from header tabs.
      document.getElementById('childLoginTab').classList.remove('active');
      document.getElementById('parentLoginTab').classList.remove('active');
      document.getElementById('teacherLoginTab').classList.remove('active');
      
      if(type === "child"){
        document.getElementById('childLoginForm').classList.remove('hidden');
        document.getElementById('childLoginTab').classList.add('active');
      }
      else if(type === "parent"){
        document.getElementById('parentLoginForm').classList.remove('hidden');
        document.getElementById('parentLoginTab').classList.add('active');
      }
      else if(type === "teacher"){
        document.getElementById('teacherLoginForm').classList.remove('hidden');
        document.getElementById('teacherLoginTab').classList.add('active');
      }
    }
    function showRegisterForm() {
      document.getElementById('childLoginForm').classList.add('hidden');
      document.getElementById('childRegisterForm').classList.remove('hidden');
    }
    function showLoginForm() {
      document.getElementById('childRegisterForm').classList.add('hidden');
      document.getElementById('childLoginForm').classList.remove('hidden');
    }
    function showParentRegisterForm() {
      document.getElementById('parentLoginForm').classList.add('hidden');
      document.getElementById('parentRegisterForm').classList.remove('hidden');
    }
    function showParentLoginForm() {
      document.getElementById('parentRegisterForm').classList.add('hidden');
      document.getElementById('parentLoginForm').classList.remove('hidden');
    }
    
    /* ================================
       Child Login Function
    ================================ */
    function childLogin() {
      const email = document.getElementById('childEmail').value.trim();
      const password = document.getElementById('childPassword').value;
      var users = getChildUsers();
      let valid = false;
      for (let user of users) {
        if (user.username === email && user.password === password) {
          valid = true;
          currentChild = email;
          break;
        }
      }
      if (valid) {
        localStorage.setItem("loggedInChild", currentChild);
        document.getElementById('loginContainer').classList.add('hidden');
        document.getElementById('childDashboard').classList.remove('hidden');
        switchChildTab('attendance');
        var now = new Date();
        var todayStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}`;
        var records = getAttendanceRecords(currentChild);
        if (records[todayStr]) {
          document.getElementById('attendanceMsg').textContent = "Attendance marked at " + records[todayStr];
          document.getElementById('attendanceBtn').disabled = true;
        }
        loadStudyMaterials();
        renderAttendanceCalendar("attendanceCalendar");
        loadNotifications();
        loadTestList();
        loadResults();
        loadProfile();
      } else {
        alert("Invalid credentials. Please register if you do not have an account.");
      }
    }
    
    /* ================================
       Child Registration Function
       (with custom display name and parent email)
    ================================ */
    function childRegister() {
      const name = document.getElementById('regName').value.trim();
      const email = document.getElementById('regEmail').value.trim();
      const password = document.getElementById('regPassword').value;
      const passwordConfirm = document.getElementById('regPasswordConfirm').value;
      const parentEmail = document.getElementById('regParent').value.trim();
      if (!name || !email || !password || !passwordConfirm) {
        alert("Please fill in all required fields.");
        return;
      }
      if (!email.includes("@") || !email.includes(".")) {
        alert("Please enter a valid email address.");
        return;
      }
      if (password !== passwordConfirm) {
        alert("Passwords do not match.");
        return;
      }
      var users = getChildUsers();
      for (let user of users) {
        if (user.username === email) {
          alert("User already registered. Please login.");
          return;
        }
      }
      users.push({ username: email, password: password, name: name, parent: parentEmail });
      setChildUsers(users);
      alert("Registration successful! Please login.");
      showLoginForm();
    }
    
    /* ================================
       Parent Registration Function
    ================================ */
    function parentRegister() {
      const email = document.getElementById('parentRegEmail').value.trim();
      const password = document.getElementById('parentRegPassword').value;
      const passwordConfirm = document.getElementById('parentRegPasswordConfirm').value;
      if (!email || !password || !passwordConfirm) {
        alert("Please fill in all fields.");
        return;
      }
      if (!email.includes("@") || !email.includes(".")) {
        alert("Please enter a valid email address.");
        return;
      }
      if (password !== passwordConfirm) {
        alert("Passwords do not match.");
        return;
      }
      var users = getParentUsers();
      for (let user of users) {
        if (user.username === email) {
          alert("Parent already registered. Please login.");
          return;
        }
      }
      users.push({ username: email, password: password });
      setParentUsers(users);
      alert("Parent registration successful! Please login.");
      showParentLoginForm();
    }
    
    /* ================================
       Parent Login Function
    ================================ */
    function parentLogin() {
      const email = document.getElementById('parentEmail').value.trim();
      const password = document.getElementById('parentPassword').value;
      var users = getParentUsers();
      let valid = false;
      for (let user of users) {
        if (user.username === email && user.password === password) {
          valid = true;
          break;
        }
      }
      if (valid) {
        localStorage.setItem("loggedInParent", email);
        document.getElementById('loginContainer').classList.add('hidden');
        document.getElementById('parentDashboard').classList.remove('hidden');
        switchParentTab('profiles');
      } else {
        alert("Invalid parent credentials.");
      }
    }
    
    /* ================================
       Teacher Login Function
    ================================ */
    function teacherLogin() {
      const username = document.getElementById('teacherUsername').value;
      const password = document.getElementById('teacherPassword').value;
      if (username === teacherCredentials.username && password === teacherCredentials.password) {
        document.getElementById('loginContainer').classList.add('hidden');
        document.getElementById('teacherDashboard').classList.remove('hidden');
        switchTeacherTab('attendance');
      } else {
        alert("Invalid teacher credentials.");
      }
    }
    
    /* ================================
       Child Dashboard Tab Switching
    ================================ */
    function switchChildTab(tab) {
      document.querySelectorAll('.dashboard-nav ul li[data-tab]').forEach(li => {
        li.classList.remove('active');
        if (li.dataset.tab === tab) li.classList.add('active');
      });
      // Hide all child sections
      document.getElementById('childAttendanceTab').classList.add('hidden');
      document.getElementById('childMaterialsTab').classList.add('hidden');
      document.getElementById('childTestsTab').classList.add('hidden');
      document.getElementById('childResultsTab').classList.add('hidden');
      document.getElementById('childProfileTab').classList.add('hidden');
      if (tab === 'attendance') {
        document.getElementById('childAttendanceTab').classList.remove('hidden');
        renderAttendanceCalendar("attendanceCalendar");
        loadNotifications();
      } else if (tab === 'materials') {
        document.getElementById('childMaterialsTab').classList.remove('hidden');
        loadStudyMaterials();
      } else if (tab === 'tests') {
        document.getElementById('childTestsTab').classList.remove('hidden');
        loadTestList();
      } else if (tab === 'results') {
        document.getElementById('childResultsTab').classList.remove('hidden');
        loadResults();
      } else if (tab === 'profile') {
        document.getElementById('childProfileTab').classList.remove('hidden');
        loadProfile();
      }
    }
    
    /* ================================
       Teacher Dashboard Tab Switching
    ================================ */
    function switchTeacherTab(tab) {
      document.querySelectorAll('.teacher-nav ul li[data-tab]').forEach(li => {
        li.classList.remove('active');
        if (li.dataset.tab === tab) li.classList.add('active');
      });
      if (tab === 'attendance') {
        loadTeacherAttendance();
      } else if (tab === 'reviewTests') {
        loadTeacherReview();
      } else if (tab === 'uploadTest') {
        showTestUploadForm();
      } else if (tab === 'uploadMaterial') {
        showMaterialUploadForm();
      }
    }
    
    /* ================================
       Parent Dashboard Tab Switching
    ================================ */
    function switchParentTab(tab) {
      document.querySelectorAll('.parent-nav ul li[data-tab]').forEach(li => {
        li.classList.remove('active');
        if (li.dataset.tab === tab) li.classList.add('active');
      });
      if (tab === 'profiles') {
        loadParentProfiles();
      } else if (tab === 'progress') {
        loadParentProgress();
      }
    }
    
    /* ================================
       Child Profile Functions
    ================================ */
    function loadProfile() {
      const profileDiv = document.getElementById('profileInfo');
      profileDiv.innerHTML = "";
      let users = getChildUsers();
      let user = users.find(u => u.username === currentChild);
      if (user) {
        profileDiv.innerHTML = `
          <p><strong>Name:</strong> ${user.name}</p>
          <p><strong>Email:</strong> ${user.username}</p>
          <p><strong>Parent Email:</strong> ${user.parent ? user.parent : "Not provided"}</p>
        `;
      }
    }
    function editProfile() {
      let users = getChildUsers();
      let userIndex = users.findIndex(u => u.username === currentChild);
      if (userIndex === -1) return;
      let newName = prompt("Enter your new display name:", users[userIndex].name || "");
      let newParent = prompt("Enter your new parent email (or leave blank):", users[userIndex].parent || "");
      if (newName !== null) {
        users[userIndex].name = newName.trim();
      }
      if (newParent !== null) {
        users[userIndex].parent = newParent.trim();
      }
      setChildUsers(users);
      loadProfile();
      alert("Profile updated!");
    }
    
    /* ================================
       Teacher & Parent: Attendance, Materials, Tests, Results
       (Use same functions for attendance, notifications, tests, results)
    ================================ */
    function markAttendance() {
      const now = new Date();
      const todayStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}`;
      const records = getAttendanceRecords(currentChild);
      if (records[todayStr]) {
        alert("Attendance already marked for today.");
        return;
      }
      records[todayStr] = now.toLocaleTimeString();
      setAttendanceRecords(currentChild, records);
      document.getElementById('attendanceMsg').textContent = "Attendance marked at " + records[todayStr];
      document.getElementById('attendanceBtn').disabled = true;
      renderAttendanceCalendar("attendanceCalendar");
    }
    
    function loadStudyMaterials() {
      // First, define static materials (optional)
      var staticMaterials = {
        "11th Grade": {
          "Physics": [
            { chapter: "Mechanics", pdf: "materials/11th/physics/mechanics.pdf" },
            { chapter: "Kinematics", pdf: "materials/11th/physics/kinematics.pdf" }
          ],
          "Chemistry": [
            { chapter: "Organic Chemistry", pdf: "materials/11th/chemistry/organic.pdf" },
            { chapter: "Inorganic Chemistry", pdf: "materials/11th/chemistry/inorganic.pdf" }
          ],
          "Biology": [
            { chapter: "Cell Biology", pdf: "materials/11th/biology/cell.pdf" },
            { chapter: "Genetics", pdf: "materials/11th/biology/genetics.pdf" }
          ]
        },
        "12th Grade": {
          "Physics": [
            { chapter: "Modern Physics", pdf: "materials/12th/physics/modern.pdf" },
            { chapter: "Electromagnetism", pdf: "materials/12th/physics/electromagnetism.pdf" }
          ],
          "Chemistry": [
            { chapter: "Physical Chemistry", pdf: "materials/12th/chemistry/physical.pdf" },
            { chapter: "Organic Chemistry", pdf: "materials/12th/chemistry/organic.pdf" }
          ],
          "Biology": [
            { chapter: "Evolution", pdf: "materials/12th/biology/evolution.pdf" },
            { chapter: "Human Physiology", pdf: "materials/12th/biology/physiology.pdf" }
          ]
        }
      };
      // Copy staticMaterials into a new object (to combine with uploads)
      let materials = Object.assign({}, staticMaterials);
      // Get teacher-uploaded materials
      let uploaded = getUploadedMaterials();
      // Group uploaded materials by grade and subject
      uploaded.forEach(function(item) {
        if (!materials[item.grade]) {
          materials[item.grade] = {};
        }
        if (!materials[item.grade][item.subject]) {
          materials[item.grade][item.subject] = [];
        }
        materials[item.grade][item.subject].push({ chapter: item.chapter, pdf: item.pdf });
      });
      // Render the materials in an accordion
      const accordion = document.getElementById('materialsAccordion');
      accordion.innerHTML = "";
      for (let grade in materials) {
        let gradeBlock = document.createElement("div");
        gradeBlock.className = "grade-block";
        let gradeTitle = document.createElement("h3");
        gradeTitle.textContent = grade;
        gradeBlock.appendChild(gradeTitle);
        for (let subject in materials[grade]) {
          let detailsEl = document.createElement("details");
          let summaryEl = document.createElement("summary");
          summaryEl.textContent = subject;
          detailsEl.appendChild(summaryEl);
          let ulEl = document.createElement("ul");
          materials[grade][subject].forEach(chapterObj => {
            let liEl = document.createElement("li");
            liEl.innerHTML = `<a href="${chapterObj.pdf}" target="_blank">${chapterObj.chapter}</a>`;
            ulEl.appendChild(liEl);
          });
          detailsEl.appendChild(ulEl);
          gradeBlock.appendChild(detailsEl);
        }
        accordion.appendChild(gradeBlock);
      }
    }
    
    function loadNotifications() {
      const notifSection = document.getElementById('notificationsSection');
      notifSection.innerHTML = "";
      const notifs = [
        { date: "2023-02-10", message: "New study material uploaded for Physics." },
        { date: "2023-02-15", message: "Mock test available for Chemistry." }
      ];
      if (notifs.length === 0) {
        notifSection.innerHTML = "<p style='text-align:center;'>No announcements available.</p>";
      } else {
        notifs.forEach(notif => {
          const div = document.createElement('div');
          div.innerHTML = `<strong>${notif.date}</strong>: ${notif.message}`;
          notifSection.appendChild(div);
        });
      }
    }
    
    /* ================================
       Student Test List
       (Now loads tests from teacher-uploaded tests plus any predefined tests;
        only shows tests with scheduled date â‰¤ today)
    ================================ */
    function loadTestList() {
      const testListDiv = document.getElementById('testList');
      testListDiv.innerHTML = "";
      // Combine predefined tests and uploaded tests
      let tests = availableTests.concat(getUploadedTests());
      // Get today's date in YYYY-MM-DD format
      let today = new Date().toISOString().split('T')[0];
      tests.forEach(test => {
        // Show test if scheduled date is not set (predefined) or scheduled date is reached
        if (!test.date || today >= test.date) {
          let keyAttempted = "childTestAttempted_" + currentChild + "_" + test.id;
          let attempted = localStorage.getItem(keyAttempted);
          let btn = document.createElement("button");
          btn.className = "btn";
          if (attempted) {
            btn.textContent = test.name + " (Attempted)";
            btn.disabled = true;
          } else {
            btn.textContent = "Take " + test.name;
            btn.onclick = function() {
              currentTestId = test.id;
              currentTestPdf = test.pdf;
              // Use teacher-specified timer if available, else default timer
              pdfTestTimeRemaining = test.timer ? test.timer : testTimeLimit;
              goToTestPage();
            };
          }
          testListDiv.appendChild(btn);
        }
      });
    }
    
    function loadResults() {
      const tbody = document.getElementById('resultsTableBody');
      tbody.innerHTML = "";
      let tests = getUploadedTests();
      // Optionally, include predefined tests as well:
      tests = availableTests.concat(tests);
      tests.forEach(test => {
        let keyAttempted = "childTestAttempted_" + currentChild + "_" + test.id;
        let keyGraded = "childTestGraded_" + currentChild + "_" + test.id;
        let keyScore = "childTestScore_" + currentChild + "_" + test.id;
        let attempted = localStorage.getItem(keyAttempted);
        let graded = localStorage.getItem(keyGraded);
        let score = localStorage.getItem(keyScore);
        let tr = document.createElement("tr");
        let tdTest = document.createElement("td");
        tdTest.textContent = test.name;
        let tdStatus = document.createElement("td");
        let tdGrade = document.createElement("td");
        if (!attempted) {
          tdStatus.textContent = "Not Attempted";
          tdGrade.textContent = "-";
        } else if (attempted && graded !== "true") {
          tdStatus.textContent = "Submitted (Pending Grading)";
          tdGrade.textContent = "-";
        } else if (graded === "true") {
          tdStatus.textContent = "Graded";
          tdGrade.textContent = score;
        }
        tr.appendChild(tdTest);
        tr.appendChild(tdStatus);
        tr.appendChild(tdGrade);
        tbody.appendChild(tr);
      });
    }
    
    /* ================================
       Test Page Navigation & Interface
    ================================ */
    function goToTestPage() {
      document.getElementById('childDashboard').classList.add('hidden');
      document.getElementById('testPage').classList.remove('hidden');
      updateTestPageInterface();
    }
    function returnToDashboard() {
      document.getElementById('testPage').classList.add('hidden');
      document.getElementById('childDashboard').classList.remove('hidden');
      loadTestList();
      loadResults();
    }
    function updateTestPageInterface() {
      let keyAttempted = "childTestAttempted_" + currentChild + "_" + currentTestId;
      if (localStorage.getItem(keyAttempted)) {
        if (localStorage.getItem("childTestGraded_" + currentChild + "_" + currentTestId) === "true") {
          document.getElementById('testInterface').innerHTML = "<p>Your test has been graded.</p>";
        } else {
          document.getElementById('testInterface').innerHTML = "<p>Your test has been submitted. Waiting for teacher grading.</p>";
        }
        document.getElementById('returnBtn').classList.remove('hidden');
      } else {
        document.getElementById('testInterface').innerHTML = `
          <div id="testNotAttempted">
            <button class="btn" onclick="startPDFTest()">Start Test</button>
          </div>
        `;
        document.getElementById('returnBtn').classList.add('hidden');
      }
    }
    function startPDFTest() {
      let keyAttempted = "childTestAttempted_" + currentChild + "_" + currentTestId;
      if (localStorage.getItem(keyAttempted)) {
        alert("Test already attempted.");
        return;
      }
      const testInterface = document.getElementById('testInterface');
      testInterface.innerHTML = `
        <div id="pdfTestContainer">
          <div id="pdfTimer">--:--</div>
          <iframe id="pdfViewer" src="${currentTestPdf}"></iframe>
        </div>
        <button class="btn" id="finishTestBtn" onclick="finishPDFTest()">Finish Test</button>
      `;
      updatePDFTimerDisplay();
      pdfTestTimerInterval = setInterval(() => {
        pdfTestTimeRemaining--;
        updatePDFTimerDisplay();
        if (pdfTestTimeRemaining <= 0) {
          clearInterval(pdfTestTimerInterval);
          finishPDFTest();
        }
      }, 1000);
    }
    function updatePDFTimerDisplay() {
      const timerDisplay = document.getElementById('pdfTimer');
      const minutes = Math.floor(pdfTestTimeRemaining / 60);
      const seconds = pdfTestTimeRemaining % 60;
      timerDisplay.textContent =
        (minutes < 10 ? "0" + minutes : minutes) + ":" +
        (seconds < 10 ? "0" + seconds : seconds);
    }
    function finishPDFTest() {
      clearInterval(pdfTestTimerInterval);
      const pdfContainer = document.getElementById('pdfTestContainer');
      const finishBtn = document.getElementById('finishTestBtn');
      if (pdfContainer) pdfContainer.style.display = 'none';
      if (finishBtn) finishBtn.style.display = 'none';
      showUploadSectionTestPage();
    }
    function showUploadSectionTestPage() {
      const testInterface = document.getElementById('testInterface');
      testInterface.innerHTML = `
        <div id="uploadSection">
          <p>Please upload a photo(s) of your answer copy (max 2 images):</p>
          <input type="file" id="uploadInput" accept="image/*" multiple />
          <button class="btn" onclick="submitUploadedTest()">Submit Test</button>
        </div>
      `;
    }
    function submitUploadedTest() {
      const input = document.getElementById('uploadInput');
      const files = input.files;
      if (!files || files.length === 0) {
        alert("Please select at least one image.");
        return;
      }
      if (files.length > 2) {
        alert("You can upload a maximum of 2 images.");
        return;
      }
      const readerPromises = [];
      for (let i = 0; i < files.length; i++) {
        readerPromises.push(new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = function(e) { resolve(e.target.result); };
          reader.onerror = function() { reject("Error reading file."); };
          reader.readAsDataURL(files[i]);
        }));
      }
      Promise.all(readerPromises)
        .then((base64Images) => {
          let keyImages = "childTestSubmissionImages_" + currentChild + "_" + currentTestId;
          let keyAttempted = "childTestAttempted_" + currentChild + "_" + currentTestId;
          let keyGraded = "childTestGraded_" + currentChild + "_" + currentTestId;
          localStorage.setItem(keyImages, JSON.stringify(base64Images));
          localStorage.setItem(keyAttempted, "true");
          localStorage.setItem(keyGraded, "false");
          document.getElementById('testInterface').innerHTML = "<p>Your test has been submitted. Waiting for teacher grading.</p>";
          document.getElementById('returnBtn').classList.remove('hidden');
        })
        .catch(err => {
          alert("There was an error processing your images.");
        });
    }
    
    /* ================================
       Teacher Test Upload Feature
    ================================ */
    function showTestUploadForm() {
      const container = document.getElementById('teacherContent');
      container.innerHTML = `
        <h3 style="text-align:center; margin-bottom:20px;">Upload New Test</h3>
        <form id="testUploadForm">
          <input type="text" id="testName" placeholder="Test Name" required /><br><br>
          <input type="file" id="testPdf" accept="application/pdf" required /><br><br>
          <input type="number" id="testTimer" placeholder="Time Limit (seconds)" required /><br><br>
          <input type="date" id="testDate" required /><br><br>
          <button class="btn" type="submit">Upload Test</button>
        </form>
      `;
      document.getElementById('testUploadForm').addEventListener('submit', function(e) {
        e.preventDefault();
        uploadTest();
      });
    }
    function uploadTest() {
      const testName = document.getElementById('testName').value.trim();
      const testTimer = parseInt(document.getElementById('testTimer').value);
      const testDate = document.getElementById('testDate').value; // YYYY-MM-DD
      const fileInput = document.getElementById('testPdf');
      if (!fileInput.files || fileInput.files.length === 0) {
        alert("Please select a PDF file.");
        return;
      }
      const file = fileInput.files[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        const pdfData = e.target.result;
        let newTest = {
          id: "uploaded_" + new Date().getTime(),
          name: testName,
          pdf: pdfData,
          timer: testTimer,
          date: testDate
        };
        let uploadedTests = getUploadedTests();
        uploadedTests.push(newTest);
        setUploadedTests(uploadedTests);
        alert("Test uploaded successfully!");
        switchTeacherTab('attendance');
      };
      reader.readAsDataURL(file);
    }
    
    /* ================================
       Teacher Study Material Upload Feature
    ================================ */
    function showMaterialUploadForm() {
      const container = document.getElementById('teacherContent');
      container.innerHTML = `
        <h3 style="text-align:center; margin-bottom:20px;">Upload Study Material</h3>
        <form id="materialUploadForm">
          <input type="text" id="materialGrade" placeholder="Grade (e.g., 11th Grade)" required /><br><br>
          <input type="text" id="materialSubject" placeholder="Subject (e.g., Physics)" required /><br><br>
          <input type="text" id="materialChapter" placeholder="Chapter Name" required /><br><br>
          <input type="file" id="materialPdf" accept="application/pdf" required /><br><br>
          <button class="btn" type="submit">Upload Material</button>
        </form>
      `;
      document.getElementById('materialUploadForm').addEventListener('submit', function(e) {
        e.preventDefault();
        uploadMaterial();
      });
    }
    function uploadMaterial() {
      const grade = document.getElementById('materialGrade').value.trim();
      const subject = document.getElementById('materialSubject').value.trim();
      const chapter = document.getElementById('materialChapter').value.trim();
      const fileInput = document.getElementById('materialPdf');
      if (!fileInput.files || fileInput.files.length === 0) {
        alert("Please select a PDF file.");
        return;
      }
      const file = fileInput.files[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        const pdfData = e.target.result;
        let newMaterial = {
          id: "material_" + new Date().getTime(),
          grade: grade,
          subject: subject,
          chapter: chapter,
          pdf: pdfData
        };
        let materials = getUploadedMaterials();
        materials.push(newMaterial);
        setUploadedMaterials(materials);
        alert("Study material uploaded successfully!");
        switchTeacherTab('attendance');
      };
      reader.readAsDataURL(file);
    }
    
    /* ================================
       Parent Dashboard Functions
    ================================ */
    function switchParentTab(tab) {
      document.querySelectorAll('.parent-nav ul li[data-tab]').forEach(li => {
        li.classList.remove('active');
        if (li.dataset.tab === tab) li.classList.add('active');
      });
      if (tab === 'profiles') {
        loadParentProfiles();
      } else if (tab === 'progress') {
        loadParentProgress();
      }
    }
    function loadParentProfiles() {
      const container = document.getElementById('parentContent');
      container.innerHTML = "<h3 style='text-align:center; margin-bottom:20px;'>My Child(ren) Profiles</h3>";
      let parentEmail = localStorage.getItem("loggedInParent");
      let users = getChildUsers();
      let myChildren = users.filter(user => user.parent && user.parent === parentEmail);
      if (myChildren.length === 0) {
        container.innerHTML += "<p>No child linked to this parent account.</p>";
      } else {
        myChildren.forEach(child => {
          container.innerHTML += `<p><strong>Name:</strong> ${child.name || child.username}<br>
                                  <strong>Email:</strong> ${child.username}</p><hr>`;
        });
      }
    }
    function loadParentProgress() {
      const container = document.getElementById('parentContent');
      container.innerHTML = "<h3 style='text-align:center; margin-bottom:20px;'>Overall Progress</h3>";
      let parentEmail = localStorage.getItem("loggedInParent");
      let users = getChildUsers();
      let myChildren = users.filter(user => user.parent && user.parent === parentEmail);
      if (myChildren.length === 0) {
        container.innerHTML += "<p>No child linked to this parent account.</p>";
      } else {
        let totalAttendanceDays = 0, totalTests = 0, totalScore = 0, gradedTests = 0;
        myChildren.forEach(child => {
          let attendance = getAttendanceRecords(child.username);
          totalAttendanceDays += Object.keys(attendance).length;
          // Consider tests from uploaded tests (or predefined tests)
          let tests = getUploadedTests();
          tests = availableTests.concat(tests);
          tests.forEach(test => {
            let keyAttempted = "childTestAttempted_" + child.username + "_" + test.id;
            if (localStorage.getItem(keyAttempted)) {
              totalTests++;
              let keyGraded = "childTestGraded_" + child.username + "_" + test.id;
              if (localStorage.getItem(keyGraded) === "true") {
                let keyScore = "childTestScore_" + child.username + "_" + test.id;
                let score = parseFloat(localStorage.getItem(keyScore));
                if (!isNaN(score)) {
                  totalScore += score;
                  gradedTests++;
                }
              }
            }
          });
        });
        let avgScore = gradedTests > 0 ? (totalScore / gradedTests).toFixed(2) : "N/A";
        container.innerHTML += `<p><strong>Total Attendance Days:</strong> ${totalAttendanceDays}</p>
                                <p><strong>Total Tests Attempted:</strong> ${totalTests}</p>
                                <p><strong>Average Test Score:</strong> ${avgScore}</p>`;
      }
    }
    
    /* ================================
       Teacher & Parent: Attendance View
    ================================ */
    function loadTeacherAttendance() {
      const container = document.getElementById('teacherContent');
      container.innerHTML = "<h3 style='text-align:center; margin-bottom:20px;'>Attendance Calendar</h3>";
      let childSelect = document.createElement('select');
      getChildUsers().forEach(user => {
        let opt = document.createElement('option');
        opt.value = user.username;
        opt.textContent = user.name ? user.name : user.username;
        childSelect.appendChild(opt);
      });
      container.appendChild(childSelect);
      container.appendChild(document.createElement('br'));
      container.appendChild(document.createElement('br'));
      if (!currentChild) { currentChild = childSelect.value; }
      let loadBtn = document.createElement('button');
      loadBtn.className = "btn";
      loadBtn.textContent = "Load Attendance";
      loadBtn.onclick = function() {
        let selectedChild = childSelect.value;
        currentChild = selectedChild;
        renderAttendanceCalendar("teacherAttendanceCalendar");
      };
      container.appendChild(loadBtn);
      container.appendChild(document.createElement('br'));
      container.appendChild(document.createElement('br'));
      let calDiv = document.createElement('div');
      calDiv.id = "teacherAttendanceCalendar";
      container.appendChild(calDiv);
      renderAttendanceCalendar("teacherAttendanceCalendar");
    }
    
    /* ================================
       Test Page Navigation & Interface
    ================================ */
    function goToTestPage() {
      document.getElementById('childDashboard').classList.add('hidden');
      document.getElementById('testPage').classList.remove('hidden');
      updateTestPageInterface();
    }
    function returnToDashboard() {
      document.getElementById('testPage').classList.add('hidden');
      document.getElementById('childDashboard').classList.remove('hidden');
      loadTestList();
      loadResults();
    }
    function updateTestPageInterface() {
      let keyAttempted = "childTestAttempted_" + currentChild + "_" + currentTestId;
      if (localStorage.getItem(keyAttempted)) {
        if (localStorage.getItem("childTestGraded_" + currentChild + "_" + currentTestId) === "true") {
          document.getElementById('testInterface').innerHTML = "<p>Your test has been graded.</p>";
        } else {
          document.getElementById('testInterface').innerHTML = "<p>Your test has been submitted. Waiting for teacher grading.</p>";
        }
        document.getElementById('returnBtn').classList.remove('hidden');
      } else {
        document.getElementById('testInterface').innerHTML = `
          <div id="testNotAttempted">
            <button class="btn" onclick="startPDFTest()">Start Test</button>
          </div>
        `;
        document.getElementById('returnBtn').classList.add('hidden');
      }
    }
    function startPDFTest() {
      let keyAttempted = "childTestAttempted_" + currentChild + "_" + currentTestId;
      if (localStorage.getItem(keyAttempted)) {
        alert("Test already attempted.");
        return;
      }
      const testInterface = document.getElementById('testInterface');
      testInterface.innerHTML = `
        <div id="pdfTestContainer">
          <div id="pdfTimer">--:--</div>
          <iframe id="pdfViewer" src="${currentTestPdf}"></iframe>
        </div>
        <button class="btn" id="finishTestBtn" onclick="finishPDFTest()">Finish Test</button>
      `;
      updatePDFTimerDisplay();
      pdfTestTimerInterval = setInterval(() => {
        pdfTestTimeRemaining--;
        updatePDFTimerDisplay();
        if (pdfTestTimeRemaining <= 0) {
          clearInterval(pdfTestTimerInterval);
          finishPDFTest();
        }
      }, 1000);
    }
    function updatePDFTimerDisplay() {
      const timerDisplay = document.getElementById('pdfTimer');
      const minutes = Math.floor(pdfTestTimeRemaining / 60);
      const seconds = pdfTestTimeRemaining % 60;
      timerDisplay.textContent =
        (minutes < 10 ? "0" + minutes : minutes) + ":" +
        (seconds < 10 ? "0" + seconds : seconds);
    }
    function finishPDFTest() {
      clearInterval(pdfTestTimerInterval);
      const pdfContainer = document.getElementById('pdfTestContainer');
      const finishBtn = document.getElementById('finishTestBtn');
      if (pdfContainer) pdfContainer.style.display = 'none';
      if (finishBtn) finishBtn.style.display = 'none';
      showUploadSectionTestPage();
    }
    function showUploadSectionTestPage() {
      const testInterface = document.getElementById('testInterface');
      testInterface.innerHTML = `
        <div id="uploadSection">
          <p>Please upload a photo(s) of your answer copy (max 2 images):</p>
          <input type="file" id="uploadInput" accept="image/*" multiple />
          <button class="btn" onclick="submitUploadedTest()">Submit Test</button>
        </div>
      `;
    }
    function submitUploadedTest() {
      const input = document.getElementById('uploadInput');
      const files = input.files;
      if (!files || files.length === 0) {
        alert("Please select at least one image.");
        return;
      }
      if (files.length > 2) {
        alert("You can upload a maximum of 2 images.");
        return;
      }
      const readerPromises = [];
      for (let i = 0; i < files.length; i++) {
        readerPromises.push(new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = function(e) { resolve(e.target.result); };
          reader.onerror = function() { reject("Error reading file."); };
          reader.readAsDataURL(files[i]);
        }));
      }
      Promise.all(readerPromises)
        .then((base64Images) => {
          let keyImages = "childTestSubmissionImages_" + currentChild + "_" + currentTestId;
          let keyAttempted = "childTestAttempted_" + currentChild + "_" + currentTestId;
          let keyGraded = "childTestGraded_" + currentChild + "_" + currentTestId;
          localStorage.setItem(keyImages, JSON.stringify(base64Images));
          localStorage.setItem(keyAttempted, "true");
          localStorage.setItem(keyGraded, "false");
          document.getElementById('testInterface').innerHTML = "<p>Your test has been submitted. Waiting for teacher grading.</p>";
          document.getElementById('returnBtn').classList.remove('hidden');
        })
        .catch(err => {
          alert("There was an error processing your images.");
        });
    }
    
    /* ================================
       Teacher Test Review & Grading
    ================================ */
    function loadTeacherReview() {
      const container = document.getElementById('teacherContent');
      container.innerHTML = "<h3 style='text-align:center; margin-bottom:20px;'>Review Test Submission</h3>";
      let childSelect = document.createElement('select');
      getChildUsers().forEach(user => {
        let opt = document.createElement('option');
        opt.value = user.username;
        opt.textContent = user.name ? user.name : user.username;
        childSelect.appendChild(opt);
      });
      let testSelect = document.createElement('select');
      // Combine predefined tests and teacher-uploaded tests
      let tests = availableTests.concat(getUploadedTests());
      tests.forEach(test => {
        let opt = document.createElement('option');
        opt.value = test.id;
        opt.textContent = test.name;
        testSelect.appendChild(opt);
      });
      let loadBtn = document.createElement('button');
      loadBtn.className = "btn";
      loadBtn.textContent = "Load Submission";
      loadBtn.onclick = function() {
        let selectedChild = childSelect.value;
        let selectedTest = testSelect.value;
        showTeacherReviewSubmission(selectedChild, selectedTest);
      };
      container.appendChild(childSelect);
      container.appendChild(document.createElement('br'));
      container.appendChild(document.createElement('br'));
      container.appendChild(testSelect);
      container.appendChild(document.createElement('br'));
      container.appendChild(document.createElement('br'));
      container.appendChild(loadBtn);
    }
    function showTeacherReviewSubmission(child, testId) {
      const container = document.getElementById('teacherContent');
      container.innerHTML = "<h3 style='text-align:center; margin-bottom:20px;'>Review Submission</h3>";
      let keyImages = "childTestSubmissionImages_" + child + "_" + testId;
      let submissionStr = localStorage.getItem(keyImages);
      if (!submissionStr) {
        container.innerHTML += "<p>No submission available for this test.</p>";
        return;
      }
      let images = JSON.parse(submissionStr);
      images.forEach((imgData) => {
        let div = document.createElement('div');
        div.style.marginBottom = "20px";
        let img = document.createElement('img');
        img.src = imgData;
        img.style.maxWidth = "100%";
        img.style.border = "1px solid #ccc";
        img.style.borderRadius = "4px";
        div.appendChild(img);
        container.appendChild(div);
      });
      let gradeLabel = document.createElement('label');
      gradeLabel.textContent = "Enter Grade: ";
      let gradeInput = document.createElement('input');
      gradeInput.type = "number";
      gradeInput.id = "gradeInput";
      gradeInput.style.marginRight = "10px";
      let gradeBtn = document.createElement('button');
      gradeBtn.className = "btn";
      gradeBtn.textContent = "Grade Test";
      gradeBtn.onclick = function() { gradeTest(child, testId); };
      container.appendChild(gradeLabel);
      container.appendChild(gradeInput);
      container.appendChild(gradeBtn);
    }
    function gradeTest(child, testId) {
      let grade = document.getElementById('gradeInput').value;
      if (grade === "") {
        alert("Please enter a grade.");
        return;
      }
      localStorage.setItem("childTestScore_" + child + "_" + testId, grade);
      localStorage.setItem("childTestGraded_" + child + "_" + testId, "true");
      document.getElementById('teacherContent').innerHTML = `<p>Test graded. Score: ${grade}.</p>`;
    }
    
    /* ================================
       Teacher Attendance View
    ================================ */
    function loadTeacherAttendance() {
      const container = document.getElementById('teacherContent');
      container.innerHTML = "<h3 style='text-align:center; margin-bottom:20px;'>Attendance Calendar</h3>";
      let childSelect = document.createElement('select');
      getChildUsers().forEach(user => {
        let opt = document.createElement('option');
        opt.value = user.username;
        opt.textContent = user.name ? user.name : user.username;
        childSelect.appendChild(opt);
      });
      container.appendChild(childSelect);
      container.appendChild(document.createElement('br'));
      container.appendChild(document.createElement('br'));
      if (!currentChild) { currentChild = childSelect.value; }
      let loadBtn = document.createElement('button');
      loadBtn.className = "btn";
      loadBtn.textContent = "Load Attendance";
      loadBtn.onclick = function() {
        let selectedChild = childSelect.value;
        currentChild = selectedChild;
        renderAttendanceCalendar("teacherAttendanceCalendar");
      };
      container.appendChild(loadBtn);
      container.appendChild(document.createElement('br'));
      container.appendChild(document.createElement('br'));
      let calDiv = document.createElement('div');
      calDiv.id = "teacherAttendanceCalendar";
      container.appendChild(calDiv);
      renderAttendanceCalendar("teacherAttendanceCalendar");
    }
    
    /* ================================
       Test Page Navigation & Interface
    ================================ */
    function goToTestPage() {
      document.getElementById('childDashboard').classList.add('hidden');
      document.getElementById('testPage').classList.remove('hidden');
      updateTestPageInterface();
    }
    function returnToDashboard() {
      document.getElementById('testPage').classList.add('hidden');
      document.getElementById('childDashboard').classList.remove('hidden');
      loadTestList();
      loadResults();
    }
    function updateTestPageInterface() {
      let keyAttempted = "childTestAttempted_" + currentChild + "_" + currentTestId;
      if (localStorage.getItem(keyAttempted)) {
        if (localStorage.getItem("childTestGraded_" + currentChild + "_" + currentTestId) === "true") {
          document.getElementById('testInterface').innerHTML = "<p>Your test has been graded.</p>";
        } else {
          document.getElementById('testInterface').innerHTML = "<p>Your test has been submitted. Waiting for teacher grading.</p>";
        }
        document.getElementById('returnBtn').classList.remove('hidden');
      } else {
        document.getElementById('testInterface').innerHTML = `
          <div id="testNotAttempted">
            <button class="btn" onclick="startPDFTest()">Start Test</button>
          </div>
        `;
        document.getElementById('returnBtn').classList.add('hidden');
      }
    }
    function startPDFTest() {
      let keyAttempted = "childTestAttempted_" + currentChild + "_" + currentTestId;
      if (localStorage.getItem(keyAttempted)) {
        alert("Test already attempted.");
        return;
      }
      const testInterface = document.getElementById('testInterface');
      testInterface.innerHTML = `
        <div id="pdfTestContainer">
          <div id="pdfTimer">--:--</div>
          <iframe id="pdfViewer" src="${currentTestPdf}"></iframe>
        </div>
        <button class="btn" id="finishTestBtn" onclick="finishPDFTest()">Finish Test</button>
      `;
      updatePDFTimerDisplay();
      pdfTestTimerInterval = setInterval(() => {
        pdfTestTimeRemaining--;
        updatePDFTimerDisplay();
        if (pdfTestTimeRemaining <= 0) {
          clearInterval(pdfTestTimerInterval);
          finishPDFTest();
        }
      }, 1000);
    }
    function updatePDFTimerDisplay() {
      const timerDisplay = document.getElementById('pdfTimer');
      const minutes = Math.floor(pdfTestTimeRemaining / 60);
      const seconds = pdfTestTimeRemaining % 60;
      timerDisplay.textContent =
        (minutes < 10 ? "0" + minutes : minutes) + ":" +
        (seconds < 10 ? "0" + seconds : seconds);
    }
    function finishPDFTest() {
      clearInterval(pdfTestTimerInterval);
      const pdfContainer = document.getElementById('pdfTestContainer');
      const finishBtn = document.getElementById('finishTestBtn');
      if (pdfContainer) pdfContainer.style.display = 'none';
      if (finishBtn) finishBtn.style.display = 'none';
      showUploadSectionTestPage();
    }
    function showUploadSectionTestPage() {
      const testInterface = document.getElementById('testInterface');
      testInterface.innerHTML = `
        <div id="uploadSection">
          <p>Please upload a photo(s) of your answer copy (max 2 images):</p>
          <input type="file" id="uploadInput" accept="image/*" multiple />
          <button class="btn" onclick="submitUploadedTest()">Submit Test</button>
        </div>
      `;
    }
    function submitUploadedTest() {
      const input = document.getElementById('uploadInput');
      const files = input.files;
      if (!files || files.length === 0) {
        alert("Please select at least one image.");
        return;
      }
      if (files.length > 2) {
        alert("You can upload a maximum of 2 images.");
        return;
      }
      const readerPromises = [];
      for (let i = 0; i < files.length; i++) {
        readerPromises.push(new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = function(e) { resolve(e.target.result); };
          reader.onerror = function() { reject("Error reading file."); };
          reader.readAsDataURL(files[i]);
        }));
      }
      Promise.all(readerPromises)
        .then((base64Images) => {
          let keyImages = "childTestSubmissionImages_" + currentChild + "_" + currentTestId;
          let keyAttempted = "childTestAttempted_" + currentChild + "_" + currentTestId;
          let keyGraded = "childTestGraded_" + currentChild + "_" + currentTestId;
          localStorage.setItem(keyImages, JSON.stringify(base64Images));
          localStorage.setItem(keyAttempted, "true");
          localStorage.setItem(keyGraded, "false");
          document.getElementById('testInterface').innerHTML = "<p>Your test has been submitted. Waiting for teacher grading.</p>";
          document.getElementById('returnBtn').classList.remove('hidden');
        })
        .catch(err => {
          alert("There was an error processing your images.");
        });
    }
    
    /* ================================
       Teacher Study Material Upload Feature
    ================================ */
    function showMaterialUploadForm() {
      const container = document.getElementById('teacherContent');
      container.innerHTML = `
        <h3 style="text-align:center; margin-bottom:20px;">Upload Study Material</h3>
        <form id="materialUploadForm">
          <input type="text" id="materialGrade" placeholder="Grade (e.g., 11th Grade)" required /><br><br>
          <input type="text" id="materialSubject" placeholder="Subject (e.g., Physics)" required /><br><br>
          <input type="text" id="materialChapter" placeholder="Chapter Name" required /><br><br>
          <input type="file" id="materialPdf" accept="application/pdf" required /><br><br>
          <button class="btn" type="submit">Upload Material</button>
        </form>
      `;
      document.getElementById('materialUploadForm').addEventListener('submit', function(e) {
        e.preventDefault();
        uploadMaterial();
      });
    }
    function uploadMaterial() {
      const grade = document.getElementById('materialGrade').value.trim();
      const subject = document.getElementById('materialSubject').value.trim();
      const chapter = document.getElementById('materialChapter').value.trim();
      const fileInput = document.getElementById('materialPdf');
      if (!fileInput.files || fileInput.files.length === 0) {
        alert("Please select a PDF file.");
        return;
      }
      const file = fileInput.files[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        const pdfData = e.target.result;
        let newMaterial = {
          id: "material_" + new Date().getTime(),
          grade: grade,
          subject: subject,
          chapter: chapter,
          pdf: pdfData
        };
        let materials = getUploadedMaterials();
        materials.push(newMaterial);
        setUploadedMaterials(materials);
        alert("Study material uploaded successfully!");
        switchTeacherTab('attendance');
      };
      reader.readAsDataURL(file);
    }
    
    /* ================================
       Parent Dashboard Functions
    ================================ */
    function switchParentTab(tab) {
      document.querySelectorAll('.parent-nav ul li[data-tab]').forEach(li => {
        li.classList.remove('active');
        if (li.dataset.tab === tab) li.classList.add('active');
      });
      if (tab === 'profiles') {
        loadParentProfiles();
      } else if (tab === 'progress') {
        loadParentProgress();
      }
    }
    function loadParentProfiles() {
      const container = document.getElementById('parentContent');
      container.innerHTML = "<h3 style='text-align:center; margin-bottom:20px;'>My Child(ren) Profiles</h3>";
      let parentEmail = localStorage.getItem("loggedInParent");
      let users = getChildUsers();
      let myChildren = users.filter(user => user.parent && user.parent === parentEmail);
      if (myChildren.length === 0) {
        container.innerHTML += "<p>No child linked to this parent account.</p>";
      } else {
        myChildren.forEach(child => {
          container.innerHTML += `<p><strong>Name:</strong> ${child.name || child.username}<br>
                                  <strong>Email:</strong> ${child.username}</p><hr>`;
        });
      }
    }
    function loadParentProgress() {
      const container = document.getElementById('parentContent');
      container.innerHTML = "<h3 style='text-align:center; margin-bottom:20px;'>Overall Progress</h3>";
      let parentEmail = localStorage.getItem("loggedInParent");
      let users = getChildUsers();
      let myChildren = users.filter(user => user.parent && user.parent === parentEmail);
      if (myChildren.length === 0) {
        container.innerHTML += "<p>No child linked to this parent account.</p>";
      } else {
        let totalAttendanceDays = 0, totalTests = 0, totalScore = 0, gradedTests = 0;
        myChildren.forEach(child => {
          let attendance = getAttendanceRecords(child.username);
          totalAttendanceDays += Object.keys(attendance).length;
          let tests = availableTests.concat(getUploadedTests());
          tests.forEach(test => {
            let keyAttempted = "childTestAttempted_" + child.username + "_" + test.id;
            if (localStorage.getItem(keyAttempted)) {
              totalTests++;
              let keyGraded = "childTestGraded_" + child.username + "_" + test.id;
              if (localStorage.getItem(keyGraded) === "true") {
                let keyScore = "childTestScore_" + child.username + "_" + test.id;
                let score = parseFloat(localStorage.getItem(keyScore));
                if (!isNaN(score)) {
                  totalScore += score;
                  gradedTests++;
                }
              }
            }
          });
        });
        let avgScore = gradedTests > 0 ? (totalScore / gradedTests).toFixed(2) : "N/A";
        container.innerHTML += `<p><strong>Total Attendance Days:</strong> ${totalAttendanceDays}</p>
                                <p><strong>Total Tests Attempted:</strong> ${totalTests}</p>
                                <p><strong>Average Test Score:</strong> ${avgScore}</p>`;
      }
    }
    
    /* ================================
       Teacher & Parent: Attendance View
    ================================ */
    function loadTeacherAttendance() {
      const container = document.getElementById('teacherContent');
      container.innerHTML = "<h3 style='text-align:center; margin-bottom:20px;'>Attendance Calendar</h3>";
      let childSelect = document.createElement('select');
      getChildUsers().forEach(user => {
        let opt = document.createElement('option');
        opt.value = user.username;
        opt.textContent = user.name ? user.name : user.username;
        childSelect.appendChild(opt);
      });
      container.appendChild(childSelect);
      container.appendChild(document.createElement('br'));
      container.appendChild(document.createElement('br'));
      if (!currentChild) { currentChild = childSelect.value; }
      let loadBtn = document.createElement('button');
      loadBtn.className = "btn";
      loadBtn.textContent = "Load Attendance";
      loadBtn.onclick = function() {
        let selectedChild = childSelect.value;
        currentChild = selectedChild;
        renderAttendanceCalendar("teacherAttendanceCalendar");
      };
      container.appendChild(loadBtn);
      container.appendChild(document.createElement('br'));
      container.appendChild(document.createElement('br'));
      let calDiv = document.createElement('div');
      calDiv.id = "teacherAttendanceCalendar";
      container.appendChild(calDiv);
      renderAttendanceCalendar("teacherAttendanceCalendar");
    }
    
    /* ================================
       Logout Functions
    ================================ */
    function childLogout() {
      document.getElementById('childDashboard').classList.add('hidden');
      document.getElementById('testPage').classList.add('hidden');
      document.getElementById('loginContainer').classList.remove('hidden');
      document.getElementById('childEmail').value = "";
      document.getElementById('childPassword').value = "";
      localStorage.removeItem("loggedInChild");
      currentChild = "";
    }
    function teacherLogout() {
      document.getElementById('teacherDashboard').classList.add('hidden');
      document.getElementById('loginContainer').classList.remove('hidden');
      document.getElementById('teacherUsername').value = "";
      document.getElementById('teacherPassword').value = "";
    }
    function parentLogout() {
      document.getElementById('parentDashboard').classList.add('hidden');
      document.getElementById('loginContainer').classList.remove('hidden');
      document.getElementById('parentEmail').value = "";
      document.getElementById('parentPassword').value = "";
      localStorage.removeItem("loggedInParent");
    }
  </script>
</body>
</html>
